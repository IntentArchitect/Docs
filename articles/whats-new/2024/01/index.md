# January 2024

Welcome to the January 2024 edition of highlights of What's New with Intent Architect.

- Highlights
- More updates
  - **[OData Query support](#odata-query-support)** - Leverage OData query functionality on your ASP.Net Core controllers.
  - **[Improvements to C# statement merging](#c-code-management-statement-block-merging-improvements)** - Improvements to heuristics and instructions for controlling statement merging behaviour within method bodies.
  - **[RabbitMQ Trigger for Azure Functions added](#rabbitmq-trigger-for-azure-functions-added)** - RabbitMQ Triggers for queue integration now available on the Azure Functions module.
  - **[EF Bulk Operations module](#ef-bulk-operations-module)** - Extends EF repositories to support Bulk Operations.
  - **[.NET 8 support](#net-8-support)** - All modules have been updated to support .NET 8.
  - **["Indented" and "data" template file builders](#indented-and-data-file-builders-for-templates)** - More quickly author templates for files such as JSON and YAML and in a way that can be easily extended by other modules.
  - **[Account Controller improvements](#account-controller-improvements)** - Multiple improvements to the the refresh token endpoint.
  - **[Software Factory statistics improvements](#removed-dependency-on-git-executable-for-software-factory-statistics)** - Gathering Software Factory statistics (lines managed, added, remove) is now faster and no longer requires Git.
  - **[NET 6+ Simple Hosting Model](#net-6-simple-hosting-model)** - Support for `Use minimal hosting model` and `Use top-level statements` on `.NET Project`s.

## Update details

### OData Query support

This modules adds OData Query support to your CQRS paradigm service end points, specifically `Query`s.

![OData Modeling](images/odata-designer.png)

For more detail, refer to the [module documentation](https://github.com/IntentArchitect/Intent.Modules.NET/blob/development/Modules/Intent.Modules.AspNetCore.ODataQuery/README.md).

Available from:

- Intent.AspNetCore.ODataQuery 1.0.0-beta.*

### C# Code Management statement block merging improvements

Improvements have been made to code management within statement blocks.

- For most statement types, old statements will now be removed from existing files when a template's output has changed.
- Instead of using `// [IntentMatch("…")]` above statements to control how they match with a statement generated by a template, one should now use the more intuitive `// [IntentFully(Match = "…")]` or `// [IntentIgnore(Match = "…")]` instructions.

For more information on controlling statement code management behaviour, refer to [our Docs article](https://docs.intentarchitect.com/articles/application-development/code-management/code-management-csharp/code-management-csharp.html#block-statement-code-management-behaviour).

Available from:

- Intent.OutputManager.RoslynWeaver 4.4.0

### RabbitMQ Trigger for Azure Functions added

We have made an improvement on the Azure Functions module, which now includes the ability to select RabbitMQ Triggers for queue integration. This feature allows developers to create functions that are triggered by messages in a RabbitMQ queue, providing a seamless integration between Azure Functions and RabbitMQ.

![Azure Functions - RabbitMQ Trigger](images/rabbitmq-trigger-az-func.png)

Available from:

- Intent.AzureFunctions 4.0.13-pre.4

### EF Bulk Operations module

This module provides patterns for doing Bulk data operation with Entity Framework Core using the `EFCore BulkExtensions`.

For more detail, refer to the [module documentation](https://github.com/IntentArchitect/Intent.Modules.NET/blob/development/Modules/Intent.Modules.EntityFrameworkCore.BulkOperations/README.md).

Available from:

- Intent.EntityFrameworkCore.BulkOperations 1.0.0-beta.*

### .NET 8 support

Final support for Intent Architect's modules for .NET 8 has been added, this includes auto upgrading of NuGet packages to their .NET 8 versions.

> [!NOTE]
> Intent Architect will need to be upgraded to the 4.1.0 beta or greater before the following modules will be visible.

Available from:

- Intent.Application.DependencyInjection 4.0.7
- Intent.Application.MediatR.Behaviours 4.2.7
- Intent.Modules.AspNetCore.Docker 3.3.9
- Intent.AspNetCore.HealthChecks 2.0.0
- Intent.AspNetCore.Identity.AccountController 3.0.1
- Intent.AspNetCore.Identity 4.0.8
- Intent.Modules.AspNetCore.MultiTenancy 5.1.0
- Intent.AspNetCore.Versioning 1.0.4
- Intent.EntityFrameworkCore.DesignTimeDbContextFactory 4.0.7
- Intent.EntityFrameworkCore 4.4.16
- Intent.Eventing.GoogleCloud.PubSub 1.0.6
- Intent.IdentityServer4.Identity.EFCore 4.0.6
- Intent.Infrastructure.DependencyInjection 4.0.8
- Intent.Security.JWT 4.1.7
- Intent.Security.MSAL 4.1.7
- Intent.VisualStudio.Projects 3.5.0

### Indented and Data File builders for templates

New `IndentedFile` and `DataFile` classes have been introduced which work in essentially the same way as the `CSharpFile` class where they employ use of a builder pattern to allow easy authoring of templates.

Both of these new classes should be immediately familiar to anyone who has used the `CSharpFile` builder when authoring templates, they add an interface to the template allowing other modules to access them for potential manipulation without requiring a hard dependency. Furthermore, metadata can be added to the different parts of the files for further introspection and structure.

The `IndentedFile` class is used for authoring of simple "indented" files, it has a `WithItems("…")` and a `WithContent("…")` method. The former will increase indentation and the latter will add content at the current indentation.

The `Datafile` class is used for authoring of structured data files such as JSON and YAML and has methods such as `WithArray("…")`, `WithObject("…")` and  `WithValue("…")`.

To get started, ensure you have the latest module builder installed and create a _New File Template_:

![New File Template context menu option](images/new-file-template.png)

Then in the properties pane on the right, select the desired _Template Method_:

![Template Method options](images/templating-method-options.png)

Once you've run the Software Factory, author your template:

```csharp
public class YamlTestTemplate : IntentTemplateBase<object>, IDataFileBuilderTemplate
{
    [IntentManaged(Mode.Fully)]
    public const string TemplateId = "CustomModule.YamlTest";

    [IntentManaged(Mode.Fully, Body = Mode.Ignore)]
    public YamlTestTemplate(IOutputTarget outputTarget, object model = null) : base(TemplateId, outputTarget, model)
    {
        DataFile = new DataFile($"YamlTest")
            .WithYamlWriter()
            .WithRootObject(this, @object =>
            {
                @object
                    .WithObject("objectField", @object => {
                        @object.WithValue("field1", "value1");
                        @object.WithValue("field1", "value2");
                    })
                    .WithArray("arrayField", array => {
                        array.WithValue("value1");
                        array.WithValue("value2");
                    })
                    .WithValue("multilineField", """
                                                 A multiline statement's first line.
                                                 Additional line.
                                                 
                                                 After a blank line.
                                                 """)
                ;
            });
    }

    [IntentManaged(Mode.Fully)]
    public IDataFile DataFile { get; }

    [IntentManaged(Mode.Fully)]
    public override ITemplateFileConfig GetTemplateFileConfig() => DataFile.GetConfig();

    [IntentManaged(Mode.Fully)]
    public override string TransformText() => DataFile.ToString();
}
```

Available from:

- Intent.ModuleBuilder 3.7.0
- Intent.Common 3.5.0

### Account Controller improvements

The Account Controller's refresh token endpoint has been improved in the following ways to be more inline with [Microsoft's identity management API introduced with .NET 8](https://devblogs.microsoft.com/dotnet/whats-new-with-identity-in-dotnet-8/):

- The `RefreshToken` token endpoint has had its name changed to `Refresh`, verb changed from `GET` to `POST` and the `RefreshToken` is now to be supplied in the body of the request.
- The access token is no longer supplied in the body or query string and the endpoint is instead decorated with an `[Authorized]` attribute meaning that, as usual for secured endpoints, the access token will now need to supplied in the header.
- When using the refresh token endpoint, the returned access token now has its claims updated with the latest for the user.

Available from:

- Intent.AspNetCore.Identity.AccountController 3.0.0

### Removed dependency on `git` executable for Software Factory statistics

During Software Factory execution, statistics of how many lines are managed and have been added or removed by the Software Factory are calculated and are visible on the "Changes" view.

Previously this was achieved using the Git executable, however, if Git was not available in a computer's path during Software Factory execution this would cause warnings and prevent statistics from being calculated. Furthermore, as calculating diffs for many files considerably increased the Software Factory execution time, it would be skipped if there were more than 50 files requiring changes.

In the latest version of Intent Architect, an in process diff algorithm is now used which removes the need for Git to be available and it also makes the diff calculations practically instant allowing statistics to always be calculated regardless of the number of changes.

Available from:

- Intent Architect 4.1.0-beta

### .NET 6+ Simple Hosting Model

It is now possible to specify `Use minimal hosting model` and `Use top-level statements` on `.NET Project`s when their `SDK` is set to `Microsoft.NET.Sdk.Web`:

![Use top-level statements and minimal hosting model options](images/use-top-level-statements-and-minimal-hosting-model-options.png).

> [!NOTE]
> Installing the updated version of the `Intent.VisualStudio.Projects` module will cause several other module to have their versions bumped as they needed to be updated to correctly update either `Startup.cs` or `Program.cs` depending on the settings chosen.

Available from:

- Intent.VisualStudio.Projects 3.5.0
